<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.kenrou.mapper.ItemsMapperCustom" >

  <resultMap id="itemCommentVO" type="com.kenrou.pojo.vo.ItemCommentVO">
    <result column="commentLevel" property="commentLevel" />
    <result column="content" property="content" />
    <result column="sepcName" property="sepcName" />
    <result column="createdTime" property="createdTime" />
    <result column="userFace" property="userFace" />
    <result column="nickname" property="nickname" />
  </resultMap>

  <select id="queryItemComments" resultMap="itemCommentVO" parameterType="Map">
    SELECT
        ic.comment_level as commentLevel,
        ic.content as content,
        ic.sepc_name as sepcName,
        ic.created_time as createdTime,
        u.face as userFace,
        u.nickname as nickname
    FROM
        items_comments ic
    LEFT JOIN
        users u
    ON
      ic.user_id = u.id
    WHERE
        ic.item_id = #{paramsMap.itemId}
        <if test="paramsMap.level != null and paramsMap.level != ''">
            AND
                ic.comment_level = #{paramsMap.level}
        </if>
  </select>

    <resultMap id="searchItemsVO" type="com.kenrou.pojo.vo.SearchItemsVO">
        <id column="itemId" property="itemId" />
        <result column="itemName" property="itemName" />
        <result column="sellCounts" property="sellCounts" />
        <result column="imgUrl" property="imgUrl" />
        <result column="price" property="price" />
    </resultMap>

    <select id="searchItems" resultMap="searchItemsVO" parameterType="Map">
        SELECT
            i.id as itemId,
            i.item_name as itemName,
            i.sell_counts as sellCounts,
            ii.url as imgUrl,
            tempSpec.price_discount as price
        FROM
            items i
        LEFT JOIN
            items_img ii
        ON
          i.id = ii.item_id
        LEFT JOIN
          (
            SELECT item_id, MIN(`price_discount`) as price_discount
            FROM items_spec
            GROUP BY item_id
            ) tempSpec
        ON i.id = tempSpec.item_id
        WHERE
          ii.is_main = 1
            <if test="paramsMap.keywords != null and paramsMap.keywords != ''">
              AND
                i.item_name like '%${paramsMap.keywords}%'
            </if>
          ORDER BY
            <choose>
              <when test="paramsMap.sort == &quot;c&quot;">
                i.sell_counts DESC
              </when>
              <when test="paramsMap.sort == &quot;p&quot;">
                tempSpec.price ASC
              </when>
              <otherwise>
                i.item_name ASC
              </otherwise>
            </choose>
    </select>
    <!-- k: 默认排序，根据name-->
    <!-- c: 销量排序-->
    <!-- p: 价格排序-->
</mapper>